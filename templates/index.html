<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Description Cleaner</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #00c9ff 0%, #92fe9d 100%); min-height: 100vh; padding: 10px; margin: 0; overflow: hidden; }
        .container { max-width: 100%; height: 100vh; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; display: flex; flex-direction: column; }
        .header { 
            background: linear-gradient(135deg, #00c9ff 0%, #92fe9d 100%); 
            color: white; 
            padding: 15px 20px; 
            text-align: center; 
            position: relative; 
            flex-shrink: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            gap: 20px;
            min-height: 70px;
        }
        .header h1 { 
            margin: 0; 
            font-size: 1.3rem; 
            font-weight: 600; 
            position: absolute;
            left: 20px;
            z-index: 10;
        }
        .header p { display: none; }
        .small-btn { 
            padding: 10px 18px; 
            border-radius: 10px; 
            font-size: 0.8rem; 
            font-weight: 700; 
            cursor: pointer; 
            text-decoration: none; 
            transition: all 0.3s ease; 
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
            border: 2px solid rgba(0,0,0,0.1);
        }
        .small-btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.35);
            opacity: 0.9;
        }
        .header-buttons { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(12px) saturate(120%);
            -webkit-backdrop-filter: blur(12px) saturate(120%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            padding: 12px 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            flex-wrap: wrap;
            max-width: fit-content;
            margin: 0 auto;
            z-index: 5;
            position: relative;
        }
        .main-content { 
            padding: 20px; 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            flex: 1; 
            overflow: hidden;
            min-height: 0;
        }
        .left-column { 
            display: flex; 
            flex-direction: column; 
            overflow-y: auto; 
            padding-right: 15px;
        }
        .right-column { 
            display: flex; 
            flex-direction: column; 
            overflow-y: auto; 
            padding-left: 15px;
        }
        .form-group { margin-bottom: 15px; flex-shrink: 0; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        textarea { width: 100%; min-height: 200px; padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 14px; font-family: 'Courier New', monospace; resize: vertical; transition: border-color 0.3s ease; }
        .btn { background: linear-gradient(135deg, #00c9ff 0%, #92fe9d 100%); color: white; border: none; padding: 15px 40px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .results { 
            display: none; 
            background: #f8f9fa; 
            border-radius: 15px; 
            padding: 20px; 
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }
        .results.show { display: flex; flex-direction: column; }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        .result-box { background: white; border-radius: 8px; padding: 12px; margin-bottom: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .result-item { background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 8px; }
        .result-inline { display:flex; gap:8px; align-items:center; margin-bottom: 6px; }
        .result-inline:last-child { margin-bottom: 0; }
        .result-inline strong { min-width: 120px; color: #495057; font-size: 0.85rem; }
        .result-inline input[type="text"], 
        .result-inline input[type="email"] { 
            flex: 1; 
            padding: 10px 15px; 
            border: 2px solid #e1e5e9; 
            border-radius: 8px; 
            font-size: 0.95rem; 
            transition: all 0.3s ease;
            background: white;
        }
        .result-inline input[type="text"]:focus, 
        .result-inline input[type="email"]:focus { 
            outline: none; 
            border-color: #00c9ff; 
            box-shadow: 0 0 0 3px rgba(0, 201, 255, 0.1);
        }
        
        /* Recruiter Info Section - Blue Theme */
        .recruiter-info-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: none;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .recruiter-info-section .result-inline strong {
            color: #1565c0;
            font-weight: 600;
            font-size: 0.85rem;
            min-width: 120px;
        }
        .recruiter-info-section input {
            border: none;
            background: white;
            padding: 6px 10px;
            font-size: 0.9rem;
        }
        .recruiter-info-section input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.15);
        }
        
        /* Sender Info Section - Green Theme */
        .sender-info-section {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: none;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .sender-info-section .result-inline strong {
            color: #2e7d32;
            font-weight: 600;
            font-size: 0.85rem;
            min-width: 120px;
        }
        .sender-info-section input,
        .sender-info-section select {
            border: none;
            background: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .sender-info-section input:focus,
        .sender-info-section select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.15);
        }
        #sender-phone {
            color: #2e7d32;
            font-weight: 500;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        /* Subject Section - Orange Theme */
        .subject-section {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border: none;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .subject-section .result-inline strong {
            color: #e65100;
            font-weight: 600;
            font-size: 0.85rem;
            min-width: 120px;
        }
        .subject-section input {
            border: none;
            background: white;
            padding: 6px 10px;
            font-size: 0.9rem;
        }
        .subject-section input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.15);
        }
        
        /* Body Section - Purple Theme */
        .body-section {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border: none;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .body-section .result-label {
            color: #6a1b9a;
            font-weight: 600;
            font-size: 0.9rem;
        }
        #emailBody {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            transition: all 0.3s ease;
        }
        #emailBody:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(156, 39, 176, 0.15);
        }
        #emailBodyPreview {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: none;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        #emailSignature {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            padding: 12px;
            border-radius: 8px;
            color: #6a1b9a;
            font-size: 0.9rem;
            white-space: pre-wrap;
            margin-top: 12px;
        }
        
        /* Metadata Badges */
        .metadata-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 600;
            margin-left: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .badge-to { background: #2196f3; color: white; }
        .badge-from { background: #4caf50; color: white; }
        .badge-subject { background: #ff9800; color: white; }
        
        /* Buttons Styling */
        #createResumeBtn, #sendEmailBtn {
            padding: 8px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            border: none;
            color: white;
            cursor: pointer;
        }
        #createResumeBtn:hover, #sendEmailBtn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        #createResumeBtn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        #sendEmailBtn {
            background: linear-gradient(135deg, #00c9ff 0%, #92fe9d 100%);
        }
        
        /* Buttons within Sender Section */
        .sender-info-section #createResumeBtn,
        .sender-info-section #sendEmailBtn {
            flex: 1;
            min-width: 120px;
        }
        
        #emailBody { width:100%; min-height:200px; padding:10px; border:1px solid #ddd; border-radius:5px; }
        
        /* Email Status Styling */
        #emailStatus {
            min-height: 24px;
            padding: 6px;
            text-align: center;
            font-size: 0.85rem;
            display: block;
        }
        #emailStatus span {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.8);
        }
        .sender-info-section #emailStatus {
            margin-top: 10px;
        }
        
        /* Folder Tiles Styling */
        .folder-tile {
            background: #FF9933;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 2px 6px rgba(255, 153, 51, 0.3);
            border: 2px solid transparent;
            word-break: break-word;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .folder-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 153, 51, 0.5);
            border-color: rgba(255,255,255,0.5);
            background: #ffaa44;
        }
        .folder-tile.selected {
            background: #ff8800;
            border-color: #fff;
            box-shadow: 0 4px 12px rgba(255, 153, 51, 0.7);
        }
        .search-suggestion-btn {
            background: rgba(0, 201, 255, 0.1);
            color: #00c9ff;
            border: 1.5px solid #00c9ff;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .search-suggestion-btn:hover {
            background: #00c9ff;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 201, 255, 0.4);
        }
        .search-suggestion-btn:active {
            transform: translateY(0);
        }
        .location-folder-item {
            padding: 10px 12px;
            margin-bottom: 6px;
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .location-folder-item:hover {
            background: #e9ecef;
            border-color: #00c9ff;
            transform: translateX(3px);
        }
        .location-folder-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }
        .location-folder-path {
            font-size: 0.75rem;
            color: #666;
            word-break: break-all;
        }
        .file-tile {
            background: #FF9933 !important;
            color: white !important;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.85rem;
            box-shadow: 0 2px 4px rgba(255, 153, 51, 0.3);
            border: 2px solid transparent;
            word-break: break-word;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .file-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 153, 51, 0.5);
            border-color: rgba(255,255,255,0.5);
            background: #ffaa44 !important;
        }
        .file-tile.selected {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
            color: white !important;
            border-color: #fff !important;
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.7) !important;
        }
        
        /* Email Sent Popup Notification */
        #emailSentPopup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 350px;
            height: 350px;
            background: #FF9933;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            font-weight: 700;
            box-shadow: 0 20px 60px rgba(255, 153, 51, 0.5);
            z-index: 10000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            pointer-events: none;
            border: 4px solid rgba(255, 255, 255, 0.3);
            animation: pulse 2s ease-in-out;
        }
        #emailSentPopup::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: #FF9933;
            opacity: 0.6;
            animation: ripple 2s ease-out infinite;
        }
        
        /* Fireworks/Crackers Animation Container */
        #fireworksContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        
        .firework-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
        }
        
        .firework-particle.red {
            background: #dc2626;
            box-shadow: 0 0 10px #dc2626, 0 0 20px #dc2626;
        }
        
        .firework-particle.rose {
            background: #e91e63;
            box-shadow: 0 0 10px #e91e63, 0 0 20px #e91e63;
        }
        
        .firework-particle.pink {
            background: #ec4899;
            box-shadow: 0 0 10px #ec4899, 0 0 20px #ec4899;
        }
        
        .firework-particle.orange {
            background: #f97316;
            box-shadow: 0 0 10px #f97316, 0 0 20px #f97316;
        }
        
        @keyframes firework {
            0% {
                transform: translate(0, 0) scale(0);
                opacity: 1;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(1);
                opacity: 0;
            }
        }
        #emailSentPopup.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        #emailSentPopup.hide {
            transform: translate(-50%, -50%) scale(0.5);
            opacity: 0;
            animation: bounceOut 0.4s ease-in;
        }
        #emailSentPopup .check-icon {
            font-size: 6rem;
            line-height: 1;
            margin-bottom: 15px;
            animation: checkmark 0.6s ease-in-out 0.2s both;
        }
        #emailSentPopup .sent-text {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 3px;
            animation: fadeInUp 0.6s ease-out 0.3s both;
        }
        
        @keyframes bounceIn {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        @keyframes bounceOut {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
        }
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 20px 60px rgba(255, 153, 51, 0.5);
            }
            50% {
                box-shadow: 0 20px 80px rgba(255, 153, 51, 0.8);
            }
        }
        @keyframes ripple {
            0% {
                transform: scale(1);
                opacity: 0.6;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        @keyframes checkmark {
            0% {
                transform: scale(0) rotate(-45deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(-45deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        @keyframes fadeInUp {
            0% {
                transform: translateY(20px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Responsive Design */
        @media (max-width:768px) { 
            body { padding: 5px; }
            .container { height: auto; min-height: 100vh; }
            .header {
                flex-direction: column;
                padding: 15px 10px;
                gap: 15px;
            }
            .header h1 {
                position: static;
                margin-bottom: 10px;
            }
            .header-buttons {
                width: 100%;
                max-width: 100%;
                padding: 8px 12px;
                gap: 6px;
            }
            .small-btn {
                font-size: 0.65rem;
                padding: 6px 12px;
            }
            .main-content { 
                grid-template-columns: 1fr; 
                grid-template-rows: auto auto;
                gap: 15px;
            }
            .left-column, .right-column {
                padding: 0;
            }
            .left-column {
                border-right: none;
                border-bottom: none;
                padding-bottom: 15px;
                margin-bottom: 15px;
            }
            .results {
                max-height: none;
            }
            .result-inline {
                flex-direction: column;
                align-items: stretch;
            }
            .result-inline strong {
                min-width: auto;
                margin-bottom: 8px;
            }
            .result-inline input,
            .result-inline select {
                width: 100% !important;
            }
            .recruiter-info-section,
            .sender-info-section,
            .subject-section,
            .body-section {
                padding: 15px;
            }
            #sender-search,
            #sender-select {
                width: 100% !important;
                margin-bottom: 8px;
            }
            .sender-info-section #createResumeBtn,
            .sender-info-section #sendEmailBtn {
                width: 100%;
                margin-bottom: 10px;
            }
        }

        /* Resume preview modal */
        .preview-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(3px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
            padding: 20px;
        }
        .preview-modal {
            width: min(1100px, 100%);
            height: min(90vh, 900px);
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .preview-toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: linear-gradient(135deg, #00c9ff 0%, #92fe9d 100%);
            color: #ffffff;
        }
        .preview-toolbar strong {
            font-size: 1rem;
        }
        .preview-toolbar span {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        .preview-toolbar button {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .preview-toolbar button:hover {
            background: rgba(255,255,255,0.3);
        }
        .preview-search {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
        }
        .preview-search input {
            flex: 1;
            border: none;
            border-radius: 8px;
            padding: 7px 10px;
            font-size: 0.85rem;
        }
        .preview-search button {
            padding: 6px 8px;
            border-radius: 8px;
            border: none;
            background: rgba(255,255,255,0.18);
            cursor: pointer;
        }
        .preview-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            font-size: 0.95rem;
            line-height: 1.6;
            background: #f9fafb;
        }
        .preview-iframe {
            flex: 1;
            border: none;
            width: 100%;
            background: #f9fafb;
        }
        .preview-loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #555;
            padding: 20px;
            font-weight: 600;
        }
        .preview-match {
            background: #ffe066;
            padding: 1px 2px;
            border-radius: 3px;
        }
        .preview-match.active {
            background: #ffd23f;
            box-shadow: 0 0 0 2px rgba(255, 210, 63, 0.6);
        }
        .preview-support-text {
            padding: 10px 16px;
            font-size: 0.85rem;
            color: #495057;
            background: #eef8ff;
            border-top: 1px solid #d0e3ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìß Email Extractor</h1>
            <div class="header-buttons">
                <a href="/" class="small-btn" style="background:#00c9ff !important; color:#000000 !important; font-weight:700 !important; border-color:#000000 !important;">üìß Email Extractor</a>
                <a href="/job_scraper" class="small-btn" style="background:#FFD700 !important; color:#000000 !important; font-weight:700 !important; border-color:#000000 !important;">üîç Job Scraper</a>
                <a href="/prompt_generator" class="small-btn" style="background:#00BFFF !important; color:#000000 !important; font-weight:700 !important; border-color:#000000 !important;">üéØ AI Developer State Farm</a>
                <a href="/dotnet_prompt_generator" class="small-btn" style="background:#DA70D6 !important; color:#000000 !important; font-weight:700 !important; border-color:#000000 !important;">üíª .NET Resume Prompt</a>
                <a href="/fullstack_prompt_generator" class="small-btn" style="background:#00CED1 !important; color:#000000 !important; font-weight:700 !important; border-color:#000000 !important;">üåê Cleveland+Health</a>
                <a href="/resume_prompt_generator" class="small-btn" style="background:#9370DB !important; color:#000000 !important; font-weight:700 !important; border-color:#000000 !important;">üìù .NET State Farm + Role Change</a>
                <a href="/resume_generator" class="small-btn" style="background:#32CD32 !important; color:#000000 !important; font-weight:700 !important; border-color:#000000 !important;">üìÑ Resume Document Builder</a>
                <a href="/fulltime" class="small-btn" style="background:#FF6347 !important; color:#000000 !important; font-weight:700 !important; border-color:#000000 !important;">üöÄ Northwestern + AI + Dev</a>
                <a href="/project_summary_prompt" class="small-btn" style="background:#FF8C00 !important; color:#000000 !important; font-weight:700 !important; border-color:#000000 !important;">üìã Project Summary Generator</a>
                <a href="/sent_emails_viewer" class="small-btn" style="background:#6a5acd !important; color:#000000 !important; font-weight:700 !important; border-color:#000000 !important;">üìä Sent Emails Archive</a>
                <a href="/otter_link" class="small-btn" style="background:#92fe9d !important; color:#000000 !important; font-weight:700 !important; border-color:#000000 !important;">üéôÔ∏è Otter Links</a>
                <a href="/salesforce_prompt_generator" class="small-btn" style="background:#00a1e0 !important; color:#000000 !important; font-weight:700 !important; border-color:#000000 !important;">‚ö° Salesforce</a>
                <a href="/salesforce_prompt_generator_role_change" class="small-btn" style="background:#1798c1 !important; color:#000000 !important; font-weight:700 !important; border-color:#000000 !important;">‚ö° Salesforce + Role Change</a>
            </div>
        </div>

        <div class="main-content">
            <!-- Left Column: Input Forms -->
            <div class="left-column">
            <form id="form">
                <div class="form-group">
                    <label for="rawText">Job Description:</label>
                    <textarea id="rawText" name="rawText" placeholder="Paste the job description or email here..." required></textarea>
                        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-start; align-items: center; flex-wrap: wrap;">
                            <button type="submit" class="btn" id="submitBtn">üîç Extract Info</button>
                            <label for="resumeFileBrowser" style="margin: 0; cursor: pointer;">
                                <button type="button" class="btn" style="background: #17a2b8; cursor: pointer;" onclick="document.getElementById('resumeFileBrowser').click();">üìÑ Select File</button>
                            </label>
                            <input type="file" id="resumeFileBrowser" accept=".pdf,.docx,.doc" style="display: none;" onchange="const fileName = this.files && this.files.length > 0 ? this.files[0].name : ''; const display = document.getElementById('resumeFileDisplay'); if(display) { display.textContent = fileName || 'No file chosen'; display.style.color = fileName ? '#2e7d32' : '#999'; } const resultsInput = document.getElementById('resumeFileBrowserResults'); if(resultsInput && this.files.length > 0) { const dataTransfer = new DataTransfer(); dataTransfer.items.add(this.files[0]); resultsInput.files = dataTransfer.files; const resultsDisplay = document.getElementById('resumeFileDisplayResults'); if(resultsDisplay) { resultsDisplay.textContent = fileName || 'No file chosen'; resultsDisplay.style.color = fileName ? '#2e7d32' : '#999'; } } updateSignaturePreview();" />
                            <span id="resumeFileDisplay" style="font-size: 0.85rem; color: #999; padding: 0 10px;">No file chosen</span>
                            <button type="button" id="sendEmailBtn" class="btn" style="display: none;">üìß Send Email</button>
                        </div>
                </div>

                <!-- Files in Folder Section (Top) -->
                <div id="folderFilesContainer" class="form-group" style="display: none; margin-top: 25px; padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; background: #f8f9fa;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <label style="margin: 0; font-weight: 600; font-size: 1rem;">üìÇ <span id="selectedFolderName"></span></label>
                            <button type="button" id="backFolderBtn" class="btn" style="background:#6c757d; padding: 5px 15px; font-size: 0.85rem; display: none;">‚¨Ö Back</button>
                        </div>
                        <button type="button" id="closeFolderFilesBtn" class="btn" style="background:#dc3545; padding: 5px 15px; font-size: 0.85rem;">‚úñ Close</button>
                    </div>
                    <div id="folderFilesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;"></div>
                </div>

                <div class="form-group" style="margin-top: 25px; padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; background: #f8f9fa;">
                    <label for="jsonInput">üìã Paste JSON Resume Data (Optional):</label>
                    <textarea id="jsonInput" placeholder='Paste JSON resume data here...' style="min-height:100px;"></textarea>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button type="button" id="generateFromJsonBtn" class="btn" style="background:#17a2b8; flex:1;">üìÑ Generate Resume from JSON</button>
                        <button type="button" id="clearJsonBtn" class="btn" style="background:#dc3545;">üóëÔ∏è Clear</button>
                    </div>
                    <div id="jsonResumeStatus" style="margin-top:10px; text-align:center; font-size:0.85rem;"></div>
                </div>

                <!-- Folders Section Container (Desktop Folders and Other Locations side by side) -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px;">
                    <!-- Desktop Folders Section -->
                    <div class="form-group" style="padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; background: #f8f9fa;">
                        <label style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                            <span style="display: flex; align-items: center; gap: 10px;">
                                <span>üìÅ Desktop Folders</span>
                                <input type="text" id="folderSearchInput" placeholder="üîç Search folders..." style="padding: 6px 12px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 0.85rem; width: 200px; transition: border-color 0.3s ease;" />
                            </span>
                            <button type="button" id="refreshFoldersBtn" class="btn" style="background:#17a2b8; padding: 5px 15px; font-size: 0.85rem;">üîÑ Refresh</button>
                        </label>
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
                            <span style="font-size: 0.8rem; color: #666; font-weight: 600;">Quick search:</span>
                            <button type="button" class="search-suggestion-btn" data-search="mcp">MCP</button>
                            <button type="button" class="search-suggestion-btn" data-search="mdm">MDM</button>
                            <button type="button" class="search-suggestion-btn" data-search="neo">Neo</button>
                            <button type="button" class="search-suggestion-btn" data-search="collibra">Collibra</button>
                            <button type="button" class="search-suggestion-btn" data-search="aws">AWS</button>
                            <button type="button" class="search-suggestion-btn" data-search="azure">Azure</button>
                            <button type="button" class="search-suggestion-btn" data-search="gcp">GCP</button>
                            <button type="button" class="search-suggestion-btn" data-search="snowflake">Snowflake</button>
                            <button type="button" class="search-suggestion-btn" data-search="databricks">Databricks</button>
                            <button type="button" class="search-suggestion-btn" data-search="hadoop">Hadoop</button>
                            <button type="button" class="search-suggestion-btn" data-search="langchain">LangChain</button>
                            <button type="button" class="search-suggestion-btn" data-search="fastapi">FastAPI</button>
                            <button type="button" class="search-suggestion-btn" data-search="dbt">DBT</button>
                            <button type="button" class="search-suggestion-btn" data-search="mlops">MLOps</button>
                            <button type="button" class="search-suggestion-btn" data-search="react">React</button>
                            <button type="button" class="search-suggestion-btn" data-search="agentic">Agentic</button>
                            <button type="button" class="search-suggestion-btn" data-search="conv">Conv</button>
                            <button type="button" class="search-suggestion-btn" data-search="de">DE</button>
                            <button type="button" class="search-suggestion-btn" data-search="copilot">Copilot</button>
                            <button type="button" class="search-suggestion-btn" data-search="python">Python</button>
                            <button type="button" class="search-suggestion-btn" data-search="java">Java</button>
                            <button type="button" class="search-suggestion-btn" data-search="spark">Spark</button>
                            <button type="button" class="search-suggestion-btn" data-search="kafka">Kafka</button>
                            <button type="button" class="search-suggestion-btn" data-search="docker">Docker</button>
                            <button type="button" class="search-suggestion-btn" data-search="kubernetes">K8s</button>
                            <button type="button" class="search-suggestion-btn" data-search="terraform">Terraform</button>
                            <button type="button" class="search-suggestion-btn" data-search="jenkins">Jenkins</button>
                            <button type="button" class="search-suggestion-btn" data-search="git">Git</button>
                            <button type="button" class="search-suggestion-btn" data-search="sql">SQL</button>
                            <button type="button" class="search-suggestion-btn" data-search="poc">POC</button>
                            <button type="button" class="search-suggestion-btn" data-search="llm">LLM</button>
                            <button type="button" class="search-suggestion-btn" data-search="rag">RAG</button>
                            <button type="button" class="search-suggestion-btn" data-search="openai">OpenAI</button>
                            <button type="button" class="search-suggestion-btn" data-search="claude">Claude</button>
                            <button type="button" class="search-suggestion-btn" data-search="gemini">Gemini</button>
                            <button type="button" class="search-suggestion-btn" data-search="vector">Vector</button>
                            <button type="button" class="search-suggestion-btn" data-search="embedding">Embedding</button>
                        </div>
                        <div id="foldersContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; min-height: 50px;">
                            <div style="text-align: center; color: #999; padding: 20px;">Loading folders...</div>
                        </div>
                    </div>

                    <!-- Other Locations Section -->
                    <div class="form-group" style="padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; background: #f8f9fa;">
                        <label style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                            <span style="display: flex; align-items: center; gap: 10px;">
                                <span>üìÇ Other Locations</span>
                                <select id="locationDropdown" style="padding: 6px 12px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 0.85rem; background: white; cursor: pointer; transition: border-color 0.3s ease; min-width: 200px;">
                                    <option value="">-- Select a location --</option>
                                </select>
                            </span>
                            <button type="button" id="refreshLocationsBtn" class="btn" style="background:#17a2b8; padding: 5px 15px; font-size: 0.85rem;">üîÑ Refresh</button>
                        </label>
                        <div id="locationFoldersContainer" style="display: none; max-height: 300px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 6px; padding: 10px; background: white; margin-top: 10px;">
                            <div style="text-align: center; color: #999; padding: 20px;">Select a location to view folders</div>
                        </div>
                    </div>
                </div>
            </form>
            </div>

            <!-- Right Column: Results -->
            <div class="right-column">
                <div class="loading" id="loading" style="display:none; text-align:center; padding: 20px;">
                <div class="spinner" style="width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid #00c9ff; border-radius:50%; animation:spin 1s linear infinite; margin:8px auto;"></div>
                <p>Processing job description...</p>
            </div>

            <div class="results" id="results">
                    <h2 style="margin-bottom: 8px; color: #333; font-size: 1.1rem; font-weight: 600;">‚úÖ Extracted Information</h2>
                <div id="resultsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="resumePreviewOverlay" class="preview-modal-overlay">
        <div class="preview-modal">
            <div class="preview-toolbar">
                <div style="display:flex; flex-direction:column;">
                    <strong>Resume Preview</strong>
                    <span id="previewFileName" style="opacity:0.85;"></span>
                </div>
                <div class="preview-search" id="previewSearchSection">
                    <input type="text" id="previewSearchInput" placeholder="Find in preview..." />
                    <button type="button" data-direction="prev" id="previewPrevBtn">‚óÄ</button>
                    <button type="button" data-direction="next" id="previewNextBtn">‚ñ∂</button>
                    <span id="previewSearchMeta" style="font-size:0.8rem;"></span>
                </div>
                <button type="button" id="closePreviewBtn" title="Close preview">‚úñ</button>
            </div>
            <div class="preview-loading" id="previewLoading">
                <div class="spinner" style="width:24px; height:24px; border:3px solid #f3f3f3; border-top:3px solid #00c9ff; border-radius:50%; animation:spin 1s linear infinite;"></div>
                <span>Loading preview...</span>
            </div>
            <div id="resumePreviewBody" class="preview-body" style="display:none;"></div>
            <iframe id="resumePreviewFrame" class="preview-iframe" style="display:none;"></iframe>
            <div id="previewSupportText" class="preview-support-text" style="display:none;"></div>
        </div>
    </div>

    <script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <script>
        // Small utilities and sender management
        let availableSenders = [];
        async function loadAvailableSenders() {
            try {
                const res = await fetch('/available_senders');
                const data = await res.json();
                availableSenders = data && data.senders ? data.senders : [];
            } catch (e) {
                console.warn('Failed to load available senders', e);
                availableSenders = [];
            }
            return availableSenders;
        }
        const availableSendersPromise = loadAvailableSenders();

        function populateSenderSelect() {
            const select = document.getElementById('sender-select');
            if (!select) return;
            select.innerHTML = '';
            if (!availableSenders.length) {
                const opt = document.createElement('option'); opt.value=''; opt.text='No senders available'; select.appendChild(opt); updateSenderPhoneDisplay(''); return;
            }
            availableSenders.forEach(s => { const opt=document.createElement('option'); opt.value=s.email; opt.text = `${s.email} (${s.name||''})`; select.appendChild(opt); });
            
            // Restore saved sender selection from localStorage
            const savedSenderEmail = localStorage.getItem('selectedSenderEmail');
            if (savedSenderEmail) {
                // Check if the saved sender still exists in available senders
                const savedSender = availableSenders.find(s => s.email === savedSenderEmail);
                if (savedSender) {
                    select.value = savedSenderEmail;
                }
            }
            
            updateSenderInfoFromSelect();
        }

        function filterSenderOptions(query) {
            const select = document.getElementById('sender-select'); if (!select) return;
            query = (query||'').toLowerCase().trim(); select.innerHTML='';
            const list = availableSenders.filter(s => !query || s.email.toLowerCase().includes(query) || (s.name||'').toLowerCase().includes(query) || (s.phone||'').toLowerCase().includes(query));
            if (!list.length) { const opt=document.createElement('option'); opt.value=''; opt.text='No senders match'; select.appendChild(opt); updateSenderPhoneDisplay(''); return; }
            list.forEach(s=>{ const opt=document.createElement('option'); opt.value=s.email; opt.text=`${s.email} (${s.name||''})`; select.appendChild(opt); });
            
            // Try to restore saved sender if it's in the filtered list
            const savedSenderEmail = localStorage.getItem('selectedSenderEmail');
            if (savedSenderEmail) {
                const savedSenderInList = list.find(s => s.email === savedSenderEmail);
                if (savedSenderInList) {
                    select.value = savedSenderEmail;
                } else {
                    select.selectedIndex = 0;
                }
            } else {
                select.selectedIndex = 0;
            }
            updateSenderInfoFromSelect();
        }

        function updateSenderInfoFromSelect() {
            const select = document.getElementById('sender-select'); if (!select) return;
            const email = select.value; 
            
            // Save selected sender to localStorage
            if (email) {
                localStorage.setItem('selectedSenderEmail', email);
            } else {
                localStorage.removeItem('selectedSenderEmail');
            }
            
            const sender = (availableSenders||[]).find(s=>s.email===email);
            const recruiterEmailInput = document.getElementById('recruiterEmail'); const recruiterNameInput = document.getElementById('recruiterName');
            if (sender) {
                // Only update recruiter email if it's empty - don't overwrite extracted recruiter email
                if (recruiterEmailInput && !recruiterEmailInput.value.trim()) {
                    recruiterEmailInput.value = sender.email;
                }
                // Only update recruiter name if it's empty - don't overwrite extracted recruiter name
                if (recruiterNameInput && !recruiterNameInput.value.trim() && sender.name) {
                    recruiterNameInput.value = sender.name;
                }
                updateSenderPhoneDisplay(sender.phone||'');
            } else { updateSenderPhoneDisplay(''); }
            // update signature display
            updateSignaturePreview();
            // also update preview if visible
            const preview = document.getElementById('emailBodyPreview'); if (preview && preview.style.display !== 'none') updateBodyPreviewWithSignature();
        }

        function updateSenderPhoneDisplay(phone) { const phoneDiv = document.getElementById('sender-phone'); if (!phoneDiv) return; phoneDiv.textContent = phone ? `Phone: ${phone}` : '\u00A0'; }

        function updateSignaturePreview() {
            const sigDiv = document.getElementById('emailSignature'); if (!sigDiv) return;
            const select = document.getElementById('sender-select'); const sender = (availableSenders||[]).find(s=>s.email=== (select ? select.value : ''));
            
            // Get resume name - prefer generated resume, then check file input for actual file
            let resumeName = '';
            if (window.generatedResumePath) {
                resumeName = window.generatedResumePath.split('/').pop().split('\\').pop();
            } else {
                const resumeFileInput = document.getElementById('resumeFileBrowser') || document.getElementById('resumeFileBrowserResults');
                if (resumeFileInput && resumeFileInput.files && resumeFileInput.files.length > 0) {
                    // Use the actual file name from the file input
                    resumeName = resumeFileInput.files[0].name;
                }
            }
            
            let html = [];
            html.push('<div style="margin-top: 8px;">Best Regards</div>');
            if (sender && sender.name) {
                html.push(`<div style="margin-top: 8px; font-weight: 600;">${sender.name}</div>`);
            }
            if (sender && sender.email) {
                html.push(`<div style="margin-top: 4px; display: flex; align-items: center; gap: 6px;"><span>üìß</span><span>${sender.email}</span></div>`);
            }
            if (sender && sender.phone) {
                html.push(`<div style="margin-top: 4px; display: flex; align-items: center; gap: 6px;"><span>üìû</span><span>Phone: ${sender.phone}</span></div>`);
            }
            if (sender && sender.linkedin) {
                const safeLinkedIn = sender.linkedin.startsWith('http') ? sender.linkedin : `https://${sender.linkedin}`;
                html.push(`<div style="margin-top: 4px; display: flex; align-items: center; gap: 6px;"><span>üîó</span><a href="${safeLinkedIn}" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: none;">${safeLinkedIn}</a></div>`);
            }
            // Resume filename removed - not needed in signature
            sigDiv.innerHTML = html.join('');
        }

        function updateGeneratedResumeStatus() {
            const statusDiv = document.getElementById('generatedResumeStatus');
            const checkbox = document.getElementById('useGeneratedResumeToggle');
            if (!statusDiv || !checkbox) return;
            if (window.generatedResumePath) {
                const fileName = window.generatedResumePath.split('/').pop().split('\\').pop();
                statusDiv.textContent = `Latest generated resume ready: ${fileName}`;
                statusDiv.style.color = '#2e7d32';
                checkbox.disabled = false;
            } else {
                statusDiv.textContent = 'No generated resume available. Upload a file above if you want to attach one.';
                statusDiv.style.color = '#999';
                checkbox.checked = false;
                checkbox.disabled = true;
            }
        }

        function updateBodyPreviewWithSignature() {
            const preview = document.getElementById('emailBodyPreview'); const textarea = document.getElementById('emailBody'); const sigDiv = document.getElementById('emailSignature');
            if (!preview || !textarea) return;
            const body = textarea.value || '';
            const sig = sigDiv ? sigDiv.innerHTML : '';
            preview.innerHTML = '<div style="white-space: pre-wrap;">' + escapeHtml(body) + '</div>' + (sig ? '<div style="margin-top: 16px; padding-top: 16px;">' + sig + '</div>' : '');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Toggle email edit mode
        window.toggleEmailEdit = function() {
            const preview = document.getElementById('emailBodyPreview');
            const textarea = document.getElementById('emailBody');
            const btn = document.getElementById('toggleEditBtn');
            if (!preview || !textarea || !btn) return;
            if (preview.style.display === 'none') {
                updateBodyPreviewWithSignature(); preview.style.display = 'block'; textarea.style.display = 'none'; btn.innerHTML = '‚úèÔ∏è Edit';
            } else {
                preview.style.display = 'none'; textarea.style.display = 'block'; btn.innerHTML = 'üëÅÔ∏è Preview';
            }
        };

        // Main handlers (create/generate/clear/send)
        let currentJobDescription = '';
        // Desktop Folders Management
        let selectedFolderPath = null;
        let selectedFilePath = null;
        let allFolders = []; // Store all folders for filtering

        function renderFolders(folders) {
            const container = document.getElementById('foldersContainer');
            if (!container) return;
            
            if (folders.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No folders found</div>';
                return;
            }
            
            container.innerHTML = '';
            folders.forEach(folder => {
                const tile = document.createElement('div');
                tile.className = 'folder-tile';
                tile.textContent = `üìÅ ${folder.name}`;
                tile.title = `${folder.name}\nLocation: ${folder.location || folder.path}`;
                tile.dataset.folderPath = folder.path;
                tile.addEventListener('click', () => handleFolderClick(folder));
                container.appendChild(tile);
            });
        }

        function filterFolders(searchTerm) {
            if (!searchTerm || searchTerm.trim() === '') {
                // Show all folders if search is empty
                const sortedFolders = [...allFolders].sort((a, b) => {
                    return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
                });
                renderFolders(sortedFolders);
                return;
            }
            
            const searchLower = searchTerm.toLowerCase().trim();
            const filtered = allFolders.filter(folder => 
                folder.name.toLowerCase().includes(searchLower)
            );
            
            // Sort filtered results
            const sortedFiltered = filtered.sort((a, b) => {
                return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
            });
            
            renderFolders(sortedFiltered);
        }

        async function loadDesktopFolders() {
            const container = document.getElementById('foldersContainer');
            if (!container) return;
            
            container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Loading folders...</div>';
            
            try {
                const response = await fetch('/list_desktop_folders');
                const data = await response.json();
                
                if (data.folders && data.folders.length > 0) {
                    // Store all folders
                    allFolders = data.folders;
                    
                    // Sort folders by name (case-insensitive)
                    const sortedFolders = [...allFolders].sort((a, b) => {
                        return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
                    });
                    
                    renderFolders(sortedFolders);
                } else {
                    allFolders = [];
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No folders found on Desktop</div>';
                }
            } catch (error) {
                console.error('Error loading folders:', error);
                allFolders = [];
                container.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">Error loading folders</div>';
            }
        }

        async function handleFolderClick(folder, isSubfolder = false) {
            // Add to navigation stack if not already there
            if (!isSubfolder) {
                folderNavigationStack = [folder];
            } else {
                folderNavigationStack.push(folder);
            }
            
            selectedFolderPath = folder.path;
            const filesContainer = document.getElementById('folderFilesContainer');
            const filesList = document.getElementById('folderFilesList');
            const folderNameSpan = document.getElementById('selectedFolderName');
            const backBtn = document.getElementById('backFolderBtn');
            
            if (!filesContainer || !filesList || !folderNameSpan) return;
            
            filesContainer.style.display = 'block';
            folderNameSpan.textContent = folder.name;
            
            // Show/hide back button based on navigation stack
            if (backBtn) {
                backBtn.style.display = folderNavigationStack.length > 1 ? 'block' : 'none';
            }
            
            // Scroll to top of the left column immediately (after DOM update)
            requestAnimationFrame(() => {
                const leftColumn = document.querySelector('.left-column');
                if (leftColumn) {
                    leftColumn.scrollTop = 0;
                }
                // Also try window scroll as fallback
                window.scrollTo({ top: 0, behavior: 'auto' });
                document.documentElement.scrollTop = 0;
                document.body.scrollTop = 0;
            });
            filesList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Loading...</div>';
            
            try {
                const response = await fetch('/list_folder_files', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({folder_path: folder.path})
                });
                const data = await response.json();
                
                filesList.innerHTML = '';
                
                // Display folders first
                if (data.folders && data.folders.length > 0) {
                    data.folders.forEach(subfolder => {
                        const tile = document.createElement('div');
                        tile.className = 'folder-tile';
                        tile.innerHTML = `üìÅ ${subfolder.name}`;
                        tile.title = `Folder: ${subfolder.name} - Click to open`;
                        tile.dataset.folderPath = subfolder.path;
                        tile.style.cursor = 'pointer';
                        tile.style.background = '#17a2b8';
                        tile.style.color = 'white';
                        tile.style.fontWeight = '600';
                        
                        tile.addEventListener('click', () => {
                            handleFolderClick(subfolder, true);
                        });
                        
                        filesList.appendChild(tile);
                    });
                }
                
                // Display files
                if (data.files && data.files.length > 0) {
                    data.files.forEach(file => {
                        const tile = document.createElement('div');
                        tile.className = 'file-tile';
                        tile.textContent = file.name;
                        tile.title = `${file.name} - Single click to select, Double click to preview`;
                        tile.dataset.filePath = file.path;
                        
                        // Single click = select and move to top immediately
                        let clickTimer = null;
                        tile.addEventListener('click', (e) => {
                            // Immediately select and move to top
                            selectFile(file);
                            
                            // Set timer to prevent double-click from triggering if user double-clicks
                            if (clickTimer === null) {
                                clickTimer = setTimeout(() => {
                                    clickTimer = null;
                                }, 300);
                            }
                        });
                        
                        // Double click = open preview
                        tile.addEventListener('dblclick', (e) => {
                            e.preventDefault();
                            if (clickTimer) {
                                clearTimeout(clickTimer);
                                clickTimer = null;
                            }
                            // Ensure file is selected first, then open preview
                            const clickedTile = document.querySelector(`[data-file-path="${file.path}"]`);
                            if (!clickedTile || !clickedTile.classList.contains('selected')) {
                                selectFile(file);
                            }
                            // Small delay to ensure selection is applied before opening preview
                            setTimeout(() => {
                                openFilePreview(file);
                            }, 50);
                        });
                        
                        filesList.appendChild(tile);
                    });
                }
                
                // Show message if empty
                if ((!data.folders || data.folders.length === 0) && (!data.files || data.files.length === 0)) {
                    filesList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No folders or resume files found in this directory</div>';
                } else if (data.files && data.files.length === 1 && (!data.folders || data.folders.length === 0)) {
                    // If only 1 file and no folders, automatically select it
                    setTimeout(() => {
                        selectFile(data.files[0]);
                    }, 100);
                }
            } catch (error) {
                console.error('Error loading files:', error);
                filesList.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">Error loading files</div>';
            }
        }
        
        function navigateBackFolder() {
            if (folderNavigationStack.length > 1) {
                // Remove current folder from stack
                folderNavigationStack.pop();
                // Get previous folder
                const previousFolder = folderNavigationStack[folderNavigationStack.length - 1];
                // Navigate to previous folder
                handleFolderClick(previousFolder, true);
            } else if (folderNavigationStack.length === 1) {
                // Go back to root folders view
                folderNavigationStack = [];
                const filesContainer = document.getElementById('folderFilesContainer');
                if (filesContainer) {
                    filesContainer.style.display = 'none';
                }
                // Clear selection
                document.querySelectorAll('.folder-tile').forEach(tile => {
                    tile.classList.remove('selected');
                });
                document.querySelectorAll('.file-tile').forEach(tile => {
                    tile.classList.remove('selected');
                });
                selectedFolderPath = null;
                selectedFilePath = null;
            }
        }

        function selectFile(file) {
            const filesList = document.getElementById('folderFilesList');
            if (!filesList) return;
            
            // Find the clicked tile
            const clickedTile = document.querySelector(`[data-file-path="${file.path}"]`);
            if (!clickedTile) return;
            
            // Check if already selected
            const isCurrentlySelected = clickedTile.classList.contains('selected');
            
            if (isCurrentlySelected) {
                // Deselect: remove selection and reset file inputs
                clickedTile.classList.remove('selected');
                selectedFilePath = null;
                
                // Clear file inputs
                const resumeFileBrowser = document.getElementById('resumeFileBrowser');
                const resumeFileBrowserResults = document.getElementById('resumeFileBrowserResults');
                
                if (resumeFileBrowser) {
                    resumeFileBrowser.value = '';
                    const display = document.getElementById('resumeFileDisplay');
                    if (display) {
                        display.textContent = 'No file chosen';
                        display.style.color = '#999';
                    }
                }
                
                if (resumeFileBrowserResults) {
                    resumeFileBrowserResults.value = '';
                    const display = document.getElementById('resumeFileDisplayResults');
                    if (display) {
                        display.textContent = 'No file chosen';
                        display.style.color = '#999';
                    }
                }
                
                updateSignaturePreview();
                return;
            }
            
            // Select: remove previous selection from all tiles
            document.querySelectorAll('.file-tile').forEach(tile => {
                tile.classList.remove('selected');
            });
            
            // Mark as selected FIRST (this changes color to green immediately)
            clickedTile.classList.add('selected');
            
            // Force a reflow to ensure CSS is applied
            void clickedTile.offsetWidth;
            
            // Move selected tile to the top (remove from current position first)
            if (clickedTile.parentNode === filesList) {
                filesList.removeChild(clickedTile);
            }
            filesList.insertBefore(clickedTile, filesList.firstChild);
            
            selectedFilePath = file.path;
            
            // Auto-scroll to top of the left column immediately (after DOM update)
            requestAnimationFrame(() => {
                const leftColumn = document.querySelector('.left-column');
                if (leftColumn) {
                    leftColumn.scrollTop = 0;
                }
                // Also try window scroll as fallback
                window.scrollTo({ top: 0, behavior: 'auto' });
                document.documentElement.scrollTop = 0;
                document.body.scrollTop = 0;
            });
            
            // Set the file in the resume file input
            try {
                fetch(`/download_resume?path=${encodeURIComponent(file.path)}`)
                    .then(response => {
                        if (response.ok) {
                            return response.blob();
                        } else {
                            throw new Error('Failed to download file');
                        }
                    })
                    .then(blob => {
                        const fileObj = new File([blob], file.name, {type: blob.type});
                        
                        // Create a DataTransfer object to set the file
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(fileObj);
                        
                        // Set file in both file inputs
                        const resumeFileBrowser = document.getElementById('resumeFileBrowser');
                        const resumeFileBrowserResults = document.getElementById('resumeFileBrowserResults');
                        
                        if (resumeFileBrowser) {
                            resumeFileBrowser.files = dataTransfer.files;
                            const display = document.getElementById('resumeFileDisplay');
                            if (display) {
                                display.textContent = file.name;
                                display.style.color = '#2e7d32';
                            }
                        }
                        
                        if (resumeFileBrowserResults) {
                            resumeFileBrowserResults.files = dataTransfer.files;
                            const display = document.getElementById('resumeFileDisplayResults');
                            if (display) {
                                display.textContent = file.name;
                                display.style.color = '#2e7d32';
                            }
                        }
                        
                        // Update signature preview
                        updateSignaturePreview();
                    })
                    .catch(error => {
                        console.error('Error loading file:', error);
                        alert('Error loading file. Please try again.');
                    });
            } catch (error) {
                console.error('Error selecting file:', error);
            }
        }

        async function openFilePreview(file) {
            // First select the file (this will move it to top and change color to green)
            // Check if already selected to avoid double selection
            const clickedTile = document.querySelector(`[data-file-path="${file.path}"]`);
            if (!clickedTile || !clickedTile.classList.contains('selected')) {
                selectFile(file);
            } else {
                // If already selected, just ensure it's at the top
                const filesList = document.getElementById('folderFilesList');
                if (filesList && clickedTile.parentNode === filesList) {
                    filesList.removeChild(clickedTile);
                    filesList.insertBefore(clickedTile, filesList.firstChild);
                }
            }
            
            // Then open preview with search keywords
            try {
                const response = await fetch(`/download_resume?path=${encodeURIComponent(file.path)}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const fileObj = new File([blob], file.name, {type: blob.type});
                    
                    // Create a DataTransfer object to set the file
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(fileObj);
                    
                    // Set file in both file inputs
                    const resumeFileBrowser = document.getElementById('resumeFileBrowser');
                    const resumeFileBrowserResults = document.getElementById('resumeFileBrowserResults');
                    
                    if (resumeFileBrowser) {
                        resumeFileBrowser.files = dataTransfer.files;
                    }
                    
                    if (resumeFileBrowserResults) {
                        resumeFileBrowserResults.files = dataTransfer.files;
                    }
                    
                    // Update signature preview
                    updateSignaturePreview();
                    
                    // Open preview using existing function (it will read from file input)
                    openResumePreview();
                } else {
                    throw new Error('Failed to download file');
                }
            } catch (error) {
                console.error('Error loading file:', error);
                alert('Error loading file. Please try again.');
            }
        }

        // Load folders on page load
        loadDesktopFolders();
        loadAvailableLocations();

        // Function to load available locations into dropdown
        async function loadAvailableLocations() {
            const dropdown = document.getElementById('locationDropdown');
            if (!dropdown) return;
            
            try {
                const response = await fetch('/list_available_locations');
                const data = await response.json();
                
                // Clear existing options except the first one
                dropdown.innerHTML = '<option value="">-- Select a location --</option>';
                
                if (data.locations && data.locations.length > 0) {
                    data.locations.forEach(location => {
                        const option = document.createElement('option');
                        option.value = location.name;
                        option.textContent = location.name;
                        dropdown.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }

        // Function to load folders from selected location
        async function loadLocationFolders(locationName) {
            const container = document.getElementById('locationFoldersContainer');
            if (!container) return;
            
            if (!locationName) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Loading folders...</div>';
            
            try {
                const response = await fetch('/list_location_folders', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({location: locationName})
                });
                const data = await response.json();
                
                container.innerHTML = '';
                
                if (data.folders && data.folders.length > 0) {
                    data.folders.forEach(folder => {
                        const item = document.createElement('div');
                        item.className = 'location-folder-item';
                        item.title = `Location: ${folder.location || folder.path}`;
                        
                        const nameDiv = document.createElement('div');
                        nameDiv.className = 'location-folder-name';
                        nameDiv.textContent = `üìÅ ${folder.name}`;
                        
                        const pathDiv = document.createElement('div');
                        pathDiv.className = 'location-folder-path';
                        pathDiv.textContent = folder.location || folder.path;
                        
                        item.appendChild(nameDiv);
                        item.appendChild(pathDiv);
                        
                        item.addEventListener('click', () => {
                            handleFolderClick(folder, false);
                        });
                        
                        container.appendChild(item);
                    });
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No folders found in this location</div>';
                }
            } catch (error) {
                console.error('Error loading location folders:', error);
                container.innerHTML = '<div style="text-align: center; color: #dc3545; padding: 20px;">Error loading folders</div>';
            }
        }

        // Folder search input event listener
        const folderSearchInput = document.getElementById('folderSearchInput');
        if (folderSearchInput) {
            folderSearchInput.addEventListener('input', function(e) {
                filterFolders(e.target.value);
            });
            
            // Also handle focus styling
            folderSearchInput.addEventListener('focus', function() {
                this.style.borderColor = '#00c9ff';
            });
            
            folderSearchInput.addEventListener('blur', function() {
                this.style.borderColor = '#e1e5e9';
            });
        }

        // Location dropdown event listener
        const locationDropdown = document.getElementById('locationDropdown');
        if (locationDropdown) {
            locationDropdown.addEventListener('change', function(e) {
                loadLocationFolders(e.target.value);
            });
        }

        // Predefined search suggestion buttons
        document.querySelectorAll('.search-suggestion-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const searchTerm = this.dataset.search;
                if (folderSearchInput) {
                    folderSearchInput.value = searchTerm;
                    folderSearchInput.focus();
                    filterFolders(searchTerm);
                }
            });
        });

        document.addEventListener('click', async function(e){
            if (e.target && e.target.id === 'createResumeBtn') {
                const createBtn = e.target; const statusDiv = document.getElementById('emailStatus'); const jobDescription = document.getElementById('rawText')?.value || '';
                if (!jobDescription) { statusDiv.innerHTML = '<span style="color:#dc3545">‚ùå Please extract job description first</span>'; return; }
                currentJobDescription = jobDescription; createBtn.disabled=true; statusDiv.innerHTML = '<span style="color:#00c9ff">‚è≥ Creating customized resume...</span>';
                try { const response = await fetch('/create_resume',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({job_description: jobDescription})}); const data = await response.json(); if (response.ok && data.resume_path){ window.generatedResumePath = data.resume_path; const fileName = data.resume_path.split('/').pop(); const resumeFileDisplay = document.getElementById('resumeFileDisplay'); const resumeInfo = document.getElementById('resumeInfo'); if (resumeFileDisplay) { resumeFileDisplay.textContent = fileName; resumeFileDisplay.style.color = '#28a745'; } if (resumeInfo) { resumeInfo.textContent = `Ready: ${fileName}`; resumeInfo.style.color='#28a745'; } createBtn.disabled=false; updateSignaturePreview(); updateGeneratedResumeStatus(); } else { throw new Error(data.error||'Failed to create resume'); } } catch(err){ console.error(err); statusDiv.innerHTML = `<span style="color:#dc3545">‚ùå Error: ${err.message}</span>`; createBtn.disabled=false; }
            }
            if (e.target && e.target.id === 'generateFromJsonBtn') {
                const generateBtn = e.target; const statusDiv = document.getElementById('jsonResumeStatus'); const jsonInput = document.getElementById('jsonInput')?.value||'';
                if (!jsonInput){ statusDiv.innerHTML = '<span style="color:#dc3545">‚ùå Please paste JSON resume data</span>'; return; }
                generateBtn.disabled=true; statusDiv.innerHTML = '<span style="color:#17a2b8">‚è≥ Validating JSON and generating resume...</span>';
                try { const response = await fetch('/generate_resume_from_json',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({json_resume_data: jsonInput})}); const data = await response.json(); if (response.ok && data.success){ statusDiv.innerHTML = '<span style="color:#28a745">‚úÖ Resume created successfully!</span>'; const downloadLink = document.createElement('a'); downloadLink.href = `/download_resume?path=${encodeURIComponent(data.resume_path)}`; downloadLink.download = data.resume_path.split('/').pop(); downloadLink.innerHTML = 'üì• Download Resume'; downloadLink.id='jsonDownloadLink'; statusDiv.appendChild(downloadLink); window.generatedResumePath = data.resume_path; const fileName = data.resume_path.split('/').pop(); const resumeFileDisplay = document.getElementById('resumeFileDisplay'); const resumeInfo = document.getElementById('resumeInfo'); if (resumeFileDisplay) { resumeFileDisplay.textContent = fileName; resumeFileDisplay.style.color = '#28a745'; } if (resumeInfo) { resumeInfo.textContent = `Ready: ${fileName}`; resumeInfo.style.color = '#28a745'; } updateSignaturePreview(); updateGeneratedResumeStatus(); generateBtn.disabled=false; } else { throw new Error(data.error||'Failed to generate resume'); } } catch(err){ console.error(err); statusDiv.innerHTML = `<span style="color:#dc3545">‚ùå Error: ${err.message}</span>`; generateBtn.disabled=false; }
            }
            if (e.target && e.target.id === 'clearJsonBtn') { const jsonInput = document.getElementById('jsonInput'); const statusDiv = document.getElementById('jsonResumeStatus'); if (jsonInput) { jsonInput.value=''; statusDiv.innerHTML=''; const oldLink = document.getElementById('jsonDownloadLink'); if (oldLink) oldLink.remove(); statusDiv.innerHTML = '<span style="color:#17a2b8">‚úÖ JSON input cleared</span>'; setTimeout(()=>statusDiv.innerHTML='',2000); } }
            
            // Desktop folders refresh button
            if (e.target && e.target.id === 'refreshFoldersBtn') {
                e.preventDefault();
                loadDesktopFolders();
                // Clear search input when refreshing
                const searchInput = document.getElementById('folderSearchInput');
                if (searchInput) {
                    searchInput.value = '';
                }
            }
            
            // Other locations refresh button
            if (e.target && e.target.id === 'refreshLocationsBtn') {
                e.preventDefault();
                loadAvailableLocations();
                const locationDropdown = document.getElementById('locationDropdown');
                if (locationDropdown) {
                    locationDropdown.value = '';
                    loadLocationFolders('');
                }
            }
            
            // Back folder button
            if (e.target && e.target.id === 'backFolderBtn') {
                e.preventDefault();
                navigateBackFolder();
            }
            
            // Close folder files button
            if (e.target && e.target.id === 'closeFolderFilesBtn') {
                e.preventDefault();
                const filesContainer = document.getElementById('folderFilesContainer');
                if (filesContainer) {
                    filesContainer.style.display = 'none';
                }
                // Clear selection and navigation stack
                folderNavigationStack = [];
                document.querySelectorAll('.folder-tile').forEach(tile => {
                    tile.classList.remove('selected');
                });
                document.querySelectorAll('.file-tile').forEach(tile => {
                    tile.classList.remove('selected');
                });
                selectedFolderPath = null;
                selectedFilePath = null;
            }

            // Send Email button handler
            if (e.target && e.target.id === 'sendEmailBtn') {
                e.preventDefault();
                e.stopPropagation();
                
                console.log('Send Email button clicked');
                
                const sendBtn = e.target; 
                const statusDiv = document.getElementById('emailStatus');
                
                if (!statusDiv) {
                    console.error('emailStatus div not found');
                    alert('Error: Email status div not found. Please refresh the page.');
                    return;
                }
                
                console.log('Starting email send process...');
                
                const recruiterName = document.getElementById('recruiterName')?.value || '';
                const recruiterEmail = document.getElementById('recruiterEmail')?.value || '';
                const ccEmail = document.getElementById('ccEmail')?.value?.trim() || '';
                const bccEmail = document.getElementById('bccEmail')?.value?.trim() || '';
                const emailSubject = document.getElementById('emailSubject')?.value || '';
                const emailBody = document.getElementById('emailBody')?.value || '';
                const resumeFile = document.getElementById('resumeFileBrowser')?.files[0] || document.getElementById('resumeFileBrowserResults')?.files[0];
                const generatedResumePath = window.generatedResumePath || null;
                const useGeneratedResume = document.getElementById('useGeneratedResumeToggle')?.checked || false;
                
                if (!recruiterEmail) { 
                    statusDiv.innerHTML = '<span style="color:#dc3545">‚ùå Please enter recruiter email</span>'; 
                    statusDiv.style.display = 'block';
                    return; 
                }
                
                try {
                // Get sender info first (needed for signature and later processing)
                const select = document.getElementById('sender-select');
                const sender = (availableSenders||[]).find(s=>s.email=== (select ? select.value : ''));
                
                // build signature - extract text from signature div
                const sigDiv = document.getElementById('emailSignature');
                let sig = '';
                if (sigDiv) {
                    
                    // Get resume name - prefer generated resume, then check file input for actual file
                    let resumeName = '';
                    if (window.generatedResumePath) {
                        resumeName = window.generatedResumePath.split('/').pop().split('\\').pop();
                    } else {
                        const resumeFileInput = document.getElementById('resumeFileBrowser') || document.getElementById('resumeFileBrowserResults');
                        if (resumeFileInput && resumeFileInput.files && resumeFileInput.files.length > 0) {
                            // Use the actual file name from the file input
                            resumeName = resumeFileInput.files[0].name;
                        }
                    }
                    
                    // Build HTML signature matching the template style (title will be added dynamically later)
                    let sigHtml = [];
                    sigHtml.push('<p style="margin-top:32px; font-size:14px; color:#64748b;">');
                    sigHtml.push('Best regards,<br>');
                    if (sender && sender.name) {
                        sigHtml.push(`<b style="color:#0f172a;">${sender.name}</b><br>`);
                    }
                    // Title placeholder - will be replaced with job title from subject
                    sigHtml.push('<span class="job-title-placeholder" style="color:#64748b;"></span><br>');
                    if (sender && sender.email) {
                        sigHtml.push(`<span style="color:#64748b;">${sender.email}</span>`);
                    }
                    if (sender && sender.phone) {
                        if (sender && sender.email) sigHtml.push(' | ');
                        sigHtml.push(`<span style="color:#64748b;">${sender.phone}</span>`);
                    }
                    if (sender && sender.linkedin) {
                        const safeLinkedIn = sender.linkedin.startsWith('http') ? sender.linkedin : `https://${sender.linkedin}`;
                        sigHtml.push(`<br><a href="${safeLinkedIn}" style="color:#2563eb; text-decoration:none; font-weight:bold; margin-top:8px; display:inline-block; background:#2563eb; color:#ffffff; padding:12px 22px; border-radius:8px;">View LinkedIn</a>`);
                    }
                    sigHtml.push('</p>');
                    // Resume filename removed - not needed in signature
                    sig = sigHtml.join('');
                    
                    // Also create plain text version for fallback
                    let sigPlain = [];
                    sigPlain.push('Best Regards');
                    if (sender && sender.name) sigPlain.push(sender.name);
                    if (sender && sender.email) sigPlain.push(sender.email);
                    if (sender && sender.phone) sigPlain.push('Phone: ' + sender.phone);
                    if (sender && sender.linkedin) {
                        const safeLinkedIn = sender.linkedin.startsWith('http') ? sender.linkedin : `https://${sender.linkedin}`;
                        sigPlain.push('LinkedIn: ' + safeLinkedIn);
                    }
                    window.signaturePlain = sigPlain.join('\n');
                }
                let finalBody = emailBody || '';
                let finalBodyHtml = '';
                
                    // Convert email body to HTML if it contains newlines
                let bodyContent = (emailBody || '').replace(/\n/g, '<br>');
                
                // Dynamically extract job title from subject with better formatting
                let jobTitle = '';
                if (emailSubject) {
                    let cleaned = emailSubject.trim();
                    
                    // Remove common email prefixes
                    const prefixes = ['re:', 'fwd:', 'fw:', 're :', 'fwd :', 'fw :'];
                    for (let prefix of prefixes) {
                        if (cleaned.toLowerCase().startsWith(prefix)) {
                            cleaned = cleaned.substring(prefix.length).trim();
                            break;
                        }
                    }
                    
                    // Pattern 1: "Application: Job Title" or "Application for Job Title"
                    if (cleaned.includes(':')) {
                        jobTitle = cleaned.split(':')[1]?.trim() || '';
                    }
                    // Pattern 2: "Application for Job Title"
                    else if (cleaned.toLowerCase().includes('application for')) {
                        jobTitle = cleaned.replace(/application\s+for/gi, '').trim();
                    }
                    // Pattern 3: "Job Title - Application" or "Job Title Application"
                    else if (cleaned.toLowerCase().includes('application')) {
                        jobTitle = cleaned.replace(/application/gi, '').replace(/[-‚Äì‚Äî]/g, '').trim();
                    }
                    // Pattern 4: "Applying for Job Title"
                    else if (cleaned.toLowerCase().includes('applying for')) {
                        jobTitle = cleaned.replace(/applying\s+for/gi, '').trim();
                    }
                    // Pattern 5: Use the whole subject if it's reasonable length
                    else if (cleaned.length > 0 && cleaned.length < 80) {
                        jobTitle = cleaned;
                    }
                    // Pattern 6: Extract first part before common separators
                    else {
                        const separators = [' - ', ' ‚Äì ', ' ‚Äî ', ' | ', ' at ', ' for '];
                        for (let sep of separators) {
                            if (cleaned.includes(sep)) {
                                jobTitle = cleaned.split(sep)[0].trim();
                                break;
                            }
                        }
                        if (!jobTitle) {
                            jobTitle = cleaned;
                        }
                    }
                    
                    // Clean up the job title
                    jobTitle = jobTitle
                        .replace(/^[-‚Äì‚Äî\s]+|[-‚Äì‚Äî\s]+$/g, '') // Remove leading/trailing dashes and spaces
                        .replace(/\s+/g, ' ') // Normalize whitespace
                        .trim();
                    
                    // Capitalize properly (Title Case)
                    if (jobTitle) {
                        jobTitle = jobTitle.split(' ').map(word => {
                            if (word.length === 0) return word;
                            // Keep common acronyms uppercase
                            if (word.toUpperCase() === word && word.length <= 5) return word;
                            // Capitalize first letter, lowercase rest
                            return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                        }).join(' ');
                    }
                }
                
                // Fallback if no job title extracted
                if (!jobTitle || jobTitle.length === 0) {
                    jobTitle = 'Position';
                }
                
                // Get sender info for signature
                let senderName = '';
                let senderEmail = '';
                let senderPhone = '';
                if (sender && sender.name) senderName = sender.name;
                if (sender && sender.email) senderEmail = sender.email;
                if (sender && sender.phone) senderPhone = sender.phone;
                
                // Build signature HTML - use job title dynamically
                let signatureHtml = '';
                if (sig) {
                    // Replace placeholder or any hardcoded "AI & ML Engineer" with job title
                    signatureHtml = sig.replace(/<span class="job-title-placeholder"[^>]*><\/span>/gi, `<span style="color:#64748b;">${jobTitle}</span>`);
                    signatureHtml = signatureHtml.replace(/AI\s*&\s*ML\s*Engineer/gi, jobTitle);
                } else {
                    // Build signature if not already built
                    signatureHtml = '<p style="margin-top:32px; font-size:14px; color:#64748b;">';
                    signatureHtml += 'Best regards,<br>';
                    if (senderName) signatureHtml += `<b style="color:#0f172a;">${senderName}</b><br>`;
                    signatureHtml += `<span style="color:#64748b;">${jobTitle}</span><br>`;
                    if (senderEmail) signatureHtml += `<span style="color:#64748b;">${senderEmail}</span>`;
                    if (senderPhone) signatureHtml += ` | <span style="color:#64748b;">${senderPhone}</span>`;
                    signatureHtml += '</p>';
                }
                
                // Combine body content with signature
                bodyContent = bodyContent + '<br><br>' + signatureHtml;
                finalBody = finalBody + '\n\n' + (window.signaturePlain || 'Best regards');
                
                // Create professional email template with AI and ML Engineer branding
                finalBodyHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                </head>
                <body style="margin:0; padding:0; background-color:#0f172a;">
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tr>
                            <td align="center" style="padding:40px 16px;">
                                <!-- Email Card -->
                                <table width="600" cellpadding="0" cellspacing="0"
                                       style="background:#ffffff; border-radius:14px; padding:32px;
                                              font-family:Arial, Helvetica, sans-serif;">
                                    <tr>
                                        <td>
                                            <p style="margin:0; font-size:14px; color:#64748b; text-transform:uppercase; letter-spacing:1px;">
                                                Application
                                            </p>
                                            <h2 style="margin:12px 0 24px 0; color:#0f172a; font-size:24px; font-weight:600;">
                                                ${jobTitle}
                                            </h2>
                                            ${bodyContent}
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </body>
                </html>
                `;
                
                window.emailBodyHtml = finalBodyHtml;
                
                console.log('Email HTML generated, preparing to send...');
                
                // Show sending status immediately
                sendBtn.disabled = true;
                statusDiv.innerHTML = '<span style="color:#00c9ff; font-weight: 600;">‚è≥ Sending email...</span>';
                statusDiv.style.display = 'block';
                
                try {
                    console.log('Creating FormData...');
                    const formData = new FormData();
                    formData.append('recruiter_name', recruiterName);
                    formData.append('recruiter_email', recruiterEmail);
                    formData.append('subject', emailSubject);
                    formData.append('body', finalBody);
                    if (window.emailBodyHtml) {
                        formData.append('body_html', window.emailBodyHtml);
                    }
                    
                    // Add JD text for phone number extraction
                    const rawTextInput = document.getElementById('rawText');
                    if (rawTextInput && rawTextInput.value) {
                        formData.append('raw_jd_text', rawTextInput.value);
                        console.log('JD text added for phone extraction');
                    }
                    
                    // Add CC and BCC if provided
                    if (ccEmail) formData.append('cc', ccEmail);
                    if (bccEmail) formData.append('bcc', bccEmail);
                    
                    // Priority: 1) Generated resume, 2) Selected file from tiles (selectedFilePath), 3) File from file input
                    if (useGeneratedResume && generatedResumePath && !resumeFile) {
                        formData.append('resume_path', generatedResumePath);
                    } else if (selectedFilePath) {
                        // Use the file path from tile selection (most reliable)
                        formData.append('resume_path', selectedFilePath);
                    } else if (resumeFile) {
                        // Fallback to file input if no tile selection
                        formData.append('resume', resumeFile);
                    }
                    
                    const senderSelect = document.getElementById('sender-select');
                    if (senderSelect && senderSelect.value) {
                        formData.append('sender_email', senderSelect.value);
                        console.log('Sender email:', senderSelect.value);
                    } else {
                        console.warn('No sender email selected');
                    }
                    
                    console.log('Sending email request...');
                    const response = await fetch('/send_email', {
                        method: 'POST',
                        body: formData
                    });
                    console.log('Response received:', response.status);
                    
                    let data;
                    try {
                        data = await response.json();
                    } catch (jsonError) {
                        console.error('JSON parse error:', jsonError);
                        const text = await response.text();
                        console.error('Response text:', text);
                        throw new Error('Invalid response from server');
                    }
                    
                    if (response.ok && data.success) {
                        // Show popup notification
                        showEmailSentPopup();
                        // Also update status div (optional - can be removed if you only want popup)
                        statusDiv.innerHTML = '<span style="color:#28a745; font-weight: 600;">‚úÖ Email sent successfully!</span>';
                        sendBtn.disabled = false;
                        
                        // Clear job description input field
                        const jobDescriptionInput = document.getElementById('rawText');
                        if (jobDescriptionInput) {
                            jobDescriptionInput.value = '';
                        }
                    } else {
                        const errorMsg = data.error || data.message || 'Failed to send email';
                        statusDiv.innerHTML = `<span style="color:#dc3545; font-weight: 600;">‚ùå Error: ${errorMsg}</span>`;
                        sendBtn.disabled = false;
                    }
                } catch(err) {
                    console.error('Send email error:', err);
                    const errorMsg = err.message || 'Network error. Please try again.';
                    statusDiv.innerHTML = `<span style="color:#dc3545; font-weight: 600;">‚ùå Error: ${errorMsg}</span>`;
                    sendBtn.disabled = false;
                }
                } catch(outerErr) {
                    console.error('Send email handler error:', outerErr);
                    if (statusDiv) {
                        statusDiv.innerHTML = `<span style="color:#dc3545; font-weight: 600;">‚ùå Error: ${outerErr.message || 'An error occurred'}</span>`;
                        statusDiv.style.display = 'block';
                    }
                    if (sendBtn) {
                        sendBtn.disabled = false;
                    }
                }
            }

            if (e.target && e.target.id === 'previewResumeBtn') {
                e.preventDefault();
                openResumePreview();
            }
            if (e.target && e.target.id === 'closePreviewBtn') {
                closeResumePreview();
            }
        });

        // Hook up extraction
        const form = document.getElementById('form'); const submitBtn = document.getElementById('submitBtn'); const loading = document.getElementById('loading'); const results = document.getElementById('results'); const resultsContent = document.getElementById('resultsContent');
        
        // State preservation functions
        function saveState() {
            const state = {
                senderEmail: document.getElementById('sender-select')?.value || '',
                resumeFile: window.generatedResumePath || null,
                resumeFileName: null,
                ccEmail: document.getElementById('ccEmail')?.value || '',
                bccEmail: document.getElementById('bccEmail')?.value || '',
                useGeneratedResume: document.getElementById('useGeneratedResumeToggle')?.checked || false
            };
            
            // Save resume file if selected
            const resumeFileInput = document.getElementById('resumeFileBrowser') || document.getElementById('resumeFileBrowserResults');
            if (resumeFileInput && resumeFileInput.files && resumeFileInput.files.length > 0) {
                state.resumeFileName = resumeFileInput.files[0].name;
                // Store file reference (we'll need to restore it)
                state.resumeFileData = resumeFileInput.files[0];
            } else {
                // Check if resumeInfo shows a selected file (even if input was reset)
                const resumeInfo = document.getElementById('resumeInfo');
                if (resumeInfo && resumeInfo.textContent && resumeInfo.textContent.includes('Selected:')) {
                    // Extract filename from the display text
                    const displayText = resumeInfo.textContent;
                    const match = displayText.match(/Selected:\s*(.+)/);
                    if (match && match[1]) {
                        state.resumeFileName = match[1].trim();
                    }
                }
            }
            
            return state;
        }
        
        function restoreState(savedState) {
            if (!savedState) return;
            
            // Restore sender selection
            if (savedState.senderEmail) {
                setTimeout(() => {
                    const senderSelect = document.getElementById('sender-select');
                    if (senderSelect && senderSelect.value !== savedState.senderEmail) {
                        senderSelect.value = savedState.senderEmail;
                        updateSenderInfoFromSelect();
                    }
                }, 150);
            }
            
            // Restore resume file
            if (savedState.resumeFile) {
                window.generatedResumePath = savedState.resumeFile;
                setTimeout(() => {
                    const fileName = savedState.resumeFile.split('/').pop().split('\\').pop();
                    const resumeFileDisplay = document.getElementById('resumeFileDisplay');
                    const resumeInfo = document.getElementById('resumeInfo');
                    if (resumeFileDisplay) {
                        resumeFileDisplay.textContent = fileName;
                        resumeFileDisplay.style.color = '#2e7d32';
                    }
                    if (resumeInfo) {
                        resumeInfo.textContent = 'Selected: ' + fileName;
                        resumeInfo.style.color = '#2e7d32';
                    }
                    updateSignaturePreview();
                }, 200);
            } else if (savedState.resumeFileName) {
                // Restore file name display (file itself can't be restored due to browser security)
                setTimeout(() => {
                    const resumeFileDisplay = document.getElementById('resumeFileDisplay');
                    const resumeInfo = document.getElementById('resumeInfo');
                    if (resumeFileDisplay) {
                        resumeFileDisplay.textContent = savedState.resumeFileName;
                        resumeFileDisplay.style.color = '#2e7d32';
                    }
                    if (resumeInfo) {
                        resumeInfo.textContent = 'Selected: ' + savedState.resumeFileName;
                        resumeInfo.style.color = '#2e7d32';
                    }
                }, 200);
            }
            
            // Restore CC and BCC
            setTimeout(() => {
                if (savedState.ccEmail) {
                    const ccInput = document.getElementById('ccEmail');
                    if (ccInput) ccInput.value = savedState.ccEmail;
                }
                if (savedState.bccEmail) {
                    const bccInput = document.getElementById('bccEmail');
                    if (bccInput) bccInput.value = savedState.bccEmail;
                }
        }, 200);

        setTimeout(() => {
            const toggle = document.getElementById('useGeneratedResumeToggle');
            if (toggle && window.generatedResumePath && savedState.useGeneratedResume !== undefined) {
                toggle.checked = !!savedState.useGeneratedResume;
            }
            updateGeneratedResumeStatus();
        }, 220);
        }
        
        form.addEventListener('submit', async function(e){ 
            e.preventDefault(); 
            const rawText = document.getElementById('rawText').value.trim(); 
            if (!rawText) { alert('Please enter some text'); return; } 
            
            // Save current state before refreshing
            const savedState = saveState();
            
            submitBtn.disabled=true; 
            loading.style.display='block'; 
            results.style.display='none'; 
            results.classList.remove('show'); 
            try { 
                const response = await fetch('/clean_job_description',{method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({raw_text: rawText})}); 
                const data = await response.json(); 
                if (!response.ok) throw new Error(data.error||'Failed to extract information'); 
                // Store state to restore after displayResults completes
                window.savedStateToRestore = savedState;
                displayResults(data);
            } catch(err){ 
                console.error(err); 
                displayError(err.message); 
            } finally{ 
                submitBtn.disabled=false; 
                loading.style.display='none'; 
                results.style.display='flex'; 
                results.classList.add('show'); 
            } 
        });

        function displayResults(data){
            let html = '';
            const escapeHtml = (text) => { if (!text) return ''; return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); };
            // Build unified compose block
            const recruiterNameVal = (data.recruiter && data.recruiter.name) ? escapeHtml(data.recruiter.name) : '';
            const recruiterEmailVal = (data.recruiter && data.recruiter.email) ? escapeHtml(data.recruiter.email) : '';
            const emailSubjectVal = (data.email && data.email.subject) ? escapeHtml(data.email.subject) : '';
            const emailBodyVal = (data.email && data.email.body) ? data.email.body : '';
            
            // Check for saved resume file state
            let resumeFileDisplayText = 'No file chosen';
            let resumeInfoText = 'No file selected';
            let resumeInfoColor = '#999';
            if (window.savedStateToRestore) {
                if (window.savedStateToRestore.resumeFile) {
                    const fileName = window.savedStateToRestore.resumeFile.split('/').pop().split('\\').pop();
                    resumeFileDisplayText = fileName;
                    resumeInfoText = 'Selected: ' + fileName;
                    resumeInfoColor = '#2e7d32';
                } else if (window.savedStateToRestore.resumeFileName) {
                    resumeFileDisplayText = window.savedStateToRestore.resumeFileName;
                    resumeInfoText = 'Selected: ' + window.savedStateToRestore.resumeFileName;
                    resumeInfoColor = '#2e7d32';
                }
            } else if (window.generatedResumePath) {
                const fileName = window.generatedResumePath.split('/').pop().split('\\').pop();
                resumeFileDisplayText = fileName;
                resumeInfoText = 'Selected: ' + fileName;
                resumeInfoColor = '#2e7d32';
            }
            html += `
                <div class="result-box">
                    <h3 style="margin-bottom: 10px; color: #333; font-size: 1.1rem; font-weight: 600;">üìß Compose Email</h3>
                    
                    <!-- Recruiter Info Section - Blue Theme -->
                    <div class="recruiter-info-section">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <strong style="font-size: 0.85rem; color: #1565c0;">üë§ Recruiter Information</strong>
                            <span class="metadata-badge badge-to">TO</span>
                        </div>
                        <div class="result-inline">
                            <strong>Recruiter Name:</strong>
                            <input type="text" id="recruiterName" value="${recruiterNameVal}" placeholder="Recruiter's full name" />
                        </div>
                        <div class="result-inline">
                            <strong>Recruiter Email:</strong>
                            <input type="email" id="recruiterEmail" value="${recruiterEmailVal}" placeholder="recruiter@company.com" />
                        </div>
                        <div class="result-inline">
                            <strong>CC (Optional):</strong>
                            <input type="text" id="ccEmail" list="emailSuggestions" placeholder="cc@example.com (comma-separated for multiple)" autocomplete="list" />
                        </div>
                        <div class="result-inline">
                            <strong>BCC (Optional):</strong>
                            <input type="text" id="bccEmail" list="emailSuggestions" placeholder="bcc@example.com (comma-separated for multiple)" autocomplete="list" />
                        </div>
                        <datalist id="emailSuggestions">
                            <option value="max@originteksolutions.com">
                        </datalist>
                    </div>
                    
                    <!-- Sender Info Section - Green Theme -->
                    <div class="sender-info-section">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <strong style="font-size: 0.85rem; color: #2e7d32;">üì§ Sender Information</strong>
                            <span class="metadata-badge badge-from">FROM</span>
                        </div>
                        <div class="result-inline" style="align-items:center; flex-wrap: wrap;">
                            <strong>Sender (From):</strong>
                            <input id="sender-search" placeholder="Search sender..." oninput="filterSenderOptions(this.value)" style="width:180px;" />
                            <select id="sender-select" onchange="updateSenderInfoFromSelect()" style="width:320px;">
                                <option>Loading senders...</option>
                            </select>
                            <div id="sender-phone">&nbsp;</div>
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px;">
                            <label for="resumeFileBrowserResults" style="display: block; margin-bottom: 6px; color: #2e7d32; font-weight: 600; font-size: 0.85rem;">üìÑ Select Resume File:</label>
                            <div style="position: relative; display:flex; gap:8px; align-items:center; padding:6px; border:none; border-radius:6px; background:rgba(255, 255, 255, 0.7); margin-bottom: 10px;">
                                <input type="file" id="resumeFileBrowserResults" accept=".pdf,.docx,.doc" style="position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2;" onchange="const fileName = this.files && this.files.length > 0 ? this.files[0].name : ''; const leftInput = document.getElementById('resumeFileBrowser'); if(leftInput && leftInput.files.length === 0) { const dataTransfer = new DataTransfer(); dataTransfer.items.add(this.files[0]); leftInput.files = dataTransfer.files; } const display = document.getElementById('resumeFileDisplayResults'); if(display) { display.textContent = fileName || 'No file chosen'; display.style.color = fileName ? '#2e7d32' : '#999'; } const leftDisplay = document.getElementById('resumeFileDisplay'); if(leftDisplay) { leftDisplay.textContent = fileName || 'No file chosen'; leftDisplay.style.color = fileName ? '#2e7d32' : '#999'; } updateSignaturePreview();" />
                                <div id="resumeFileDisplayResults" style="flex:1; padding:6px 8px; border:none; border-radius:4px; font-size:0.85rem; background:white; color:${resumeInfoColor}; min-height: 20px; display: flex; align-items: center;">${resumeFileDisplayText}</div>
                                <span id="resumeInfo" style="flex:1; color:${resumeInfoColor}; font-size:0.85rem; display:none;">${resumeInfoText}</span>
                            </div>
                            <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:10px;">
                                <button type="button" id="previewResumeBtn" class="btn" style="background:#1b74e4; padding:8px 16px; font-size:0.85rem;">üëÅÔ∏è Preview Resume</button>
                                <small style="color:#1b4332; font-size:0.78rem;">Open a quick preview and search within (Cmd/Ctrl + F).</small>
                            </div>
                            <div style="margin-top: 6px; display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="useGeneratedResumeToggle" style="width: 16px; height: 16px;" />
                                <label for="useGeneratedResumeToggle" style="font-size: 0.85rem; color: #1b4332;">Attach the latest generated resume automatically</label>
                            </div>
                            <div id="generatedResumeStatus" style="margin-top: 4px; font-size: 0.78rem; color: #999;">No generated resume available.</div>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button type="button" id="createResumeBtn" class="btn" style="background:#28a745;">üìÑ Create Resume</button>
                        </div>
                        <div id="emailStatus" style="margin-top: 10px; text-align: center;"></div>
                    </div>
                    
                    <!-- Subject Section - Orange Theme -->
                    <div class="subject-section">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <strong style="font-size: 0.85rem; color: #e65100;">üìù Email Subject</strong>
                            <span class="metadata-badge badge-subject">SUBJECT</span>
                        </div>
                        <div class="result-inline">
                            <strong>Subject:</strong>
                            <input type="text" id="emailSubject" value="${emailSubjectVal}" placeholder="Email subject line..." />
                        </div>
                    </div>
                    
                    <!-- Body Section - Purple Theme -->
                    <div class="body-section">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <div style="display: flex; align-items: center;">
                                <div class="result-label">‚úâÔ∏è Email Body</div>
                            </div>
                            <button type="button" id="toggleEditBtn" onclick="toggleEmailEdit()" class="btn" style="padding:6px 12px; font-size:0.85rem; background:linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%);">üëÅÔ∏è Preview</button>
                        </div>
                        <div id="emailBodyPreview" style="display:none; background:white; padding:12px; border-radius:6px; border:none; white-space:pre-wrap; line-height:1.5; font-size:0.9rem;">${escapeHtml(emailBodyVal)}</div>
                        <textarea id="emailBody" placeholder="Email body content...">${escapeHtml(emailBodyVal)}</textarea>
                        <div id="emailSignature" style="margin-top:8px;">&nbsp;</div>
                    </div>
                </div>
            `;
            resultsContent.innerHTML = html;
            setTimeout(updateGeneratedResumeStatus, 0);
            // Show send button in left column after extraction
            const leftSendBtn = document.getElementById('sendEmailBtn');
            if (leftSendBtn) {
                leftSendBtn.style.display = 'inline-block';
                console.log('Send Email button is now visible');
            } else {
                console.warn('Send Email button not found in DOM');
            }
            // populate senders once loaded
            availableSendersPromise.then(()=>{
                populateSenderSelect();
                populateEmailSuggestions();
                setupEmailSuggestions();
                // Restore state after everything is loaded
                if (window.savedStateToRestore) {
                    restoreState(window.savedStateToRestore);
                    window.savedStateToRestore = null;
                }
            }).catch(()=>{
                populateSenderSelect();
                populateEmailSuggestions();
                setupEmailSuggestions();
                // Restore state after everything is loaded
                if (window.savedStateToRestore) {
                    restoreState(window.savedStateToRestore);
                    window.savedStateToRestore = null;
                }
            });
        }
        
        function setupEmailSuggestions() {
            // Ensure datalist is properly connected and suggestions are available
            const ccInput = document.getElementById('ccEmail');
            const bccInput = document.getElementById('bccEmail');
            const datalist = document.getElementById('emailSuggestions');
            
            // Verify datalist connection
            if (ccInput && datalist) {
                ccInput.setAttribute('list', 'emailSuggestions');
            }
            if (bccInput && datalist) {
                bccInput.setAttribute('list', 'emailSuggestions');
            }
        }
        
        function populateEmailSuggestions() {
            const datalist = document.getElementById('emailSuggestions');
            if (!datalist) return;
            
            // Clear existing options except the default one
            datalist.innerHTML = '<option value="max@originteksolutions.com">';
            
            // Add emails from available senders
            if (availableSenders && availableSenders.length > 0) {
                availableSenders.forEach(sender => {
                    if (sender.email) {
                        const option = document.createElement('option');
                        option.value = sender.email;
                        datalist.appendChild(option);
                    }
                });
            }
        }

        // Resume preview utilities
        const previewState = {
            objectUrl: null,
            type: 'none',
            originalHtml: '',
            matches: [],
            currentIndex: -1
        };

        const previewOverlay = document.getElementById('resumePreviewOverlay');
        if (previewOverlay) {
            previewOverlay.addEventListener('click', function(e) {
                if (e.target === previewOverlay) {
                    closeResumePreview();
                }
            });
        }

        const previewSearchInput = document.getElementById('previewSearchInput');
        if (previewSearchInput) {
            previewSearchInput.addEventListener('input', function(e) {
                if (previewState.type === 'text') {
                    performPreviewSearch(e.target.value.trim());
                }
            });
        }

        const previewPrevBtn = document.getElementById('previewPrevBtn');
        if (previewPrevBtn) {
            previewPrevBtn.addEventListener('click', function() {
                movePreviewMatch('prev');
            });
        }

        const previewNextBtn = document.getElementById('previewNextBtn');
        if (previewNextBtn) {
            previewNextBtn.addEventListener('click', function() {
                movePreviewMatch('next');
            });
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeResumePreview();
            }
        });

        async function openResumePreview() {
            const overlay = document.getElementById('resumePreviewOverlay');
            if (!overlay) return;

            // Priority: Use selectedFilePath if available (from tile selection), otherwise use file input
            let localFile = null;
            if (selectedFilePath) {
                // Use the selected file path from tiles
                try {
                    const response = await fetch(`/download_resume?path=${encodeURIComponent(selectedFilePath)}`);
                    if (response.ok) {
                        const blob = await response.blob();
                        const fileName = selectedFilePath.split('/').pop().split('\\').pop();
                        localFile = new File([blob], fileName, {type: blob.type});
                    }
                } catch (error) {
                    console.error('Error loading selected file:', error);
                }
            }
            
            // Fallback to file input if no selectedFilePath
            if (!localFile) {
                const fileInput = document.getElementById('resumeFileBrowser') || document.getElementById('resumeFileBrowserResults');
                localFile = fileInput && fileInput.files && fileInput.files.length ? fileInput.files[0] : null;
            }
            const generatedPath = window.generatedResumePath || null;

            if (!localFile && !generatedPath) {
                alert('Please select, upload, or generate a resume first.');
                return;
            }

            overlay.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            resetPreviewArea();
            showPreviewLoading();

            const fileLabel = document.getElementById('previewFileName');
            if (fileLabel) {
                const label = localFile ? localFile.name : (generatedPath ? generatedPath.split('/').pop() : '');
                fileLabel.textContent = label || '';
            }

            try {
                if (localFile) {
                    await renderPreviewFromBlob(localFile);
                } else if (generatedPath) {
                    await renderPreviewFromServer(generatedPath);
                }
            } catch (err) {
                console.error('Preview error:', err);
                showPreviewError(err.message || 'Unable to preview this file.');
            } finally {
                hidePreviewLoading();
            }
        }

        function closeResumePreview() {
            const overlay = document.getElementById('resumePreviewOverlay');
            if (!overlay || overlay.style.display === 'none') return;

            overlay.style.display = 'none';
            document.body.style.overflow = '';
            cleanupPreviewResources();
        }

        async function renderPreviewFromServer(resumePath) {
            const response = await fetch(`/preview_resume?path=${encodeURIComponent(resumePath)}`);
            if (!response.ok) {
                throw new Error('Unable to fetch resume for preview.');
            }
            const blob = await response.blob();
            const fileName = resumePath.split('/').pop();
            const file = new File([blob], fileName, { type: blob.type || '' });
            await renderPreviewFromBlob(file);
        }

        async function renderPreviewFromBlob(file) {
            if (!file) throw new Error('No file provided for preview.');
            const extension = getFileExtension(file.name || '');

            if (extension === 'pdf') {
                setPreviewIframe(file);
                toggleSearchSection(false);
                setSupportText('Tip: Click inside the preview, then use Cmd/Ctrl + F to search within the PDF.');
                return;
            }

            if (extension === 'docx') {
                if (typeof mammoth === 'undefined' || !mammoth.convertToHtml) {
                    throw new Error('DOCX preview library is unavailable.');
                }
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.convertToHtml({ arrayBuffer });
                const html = result && result.value ? result.value : '<p><em>No content detected in this document.</em></p>';
                setPreviewHtml(html);
                toggleSearchSection(true);
                setSupportText('Use the search box or Cmd/Ctrl + F to jump to keywords inside this preview.');
                return;
            }

            if (extension === 'doc') {
                throw new Error('DOC preview is limited. Please convert the file to DOCX or PDF.');
            }

            throw new Error('Unsupported file type. Please select a DOCX or PDF file.');
        }

        function setPreviewHtml(html) {
            const bodyEl = document.getElementById('resumePreviewBody');
            const frame = document.getElementById('resumePreviewFrame');
            if (!bodyEl || !frame) return;

            frame.style.display = 'none';
            frame.src = 'about:blank';
            bodyEl.style.display = 'block';
            bodyEl.innerHTML = html || '<p>No content.</p>';
            previewState.originalHtml = bodyEl.innerHTML;
            previewState.type = 'text';
            resetSearchHighlights();
        }

        function setPreviewIframe(file) {
            const frame = document.getElementById('resumePreviewFrame');
            const bodyEl = document.getElementById('resumePreviewBody');
            if (!frame || !bodyEl) return;

            bodyEl.style.display = 'none';
            if (previewState.objectUrl) {
                URL.revokeObjectURL(previewState.objectUrl);
                previewState.objectUrl = null;
            }
            const url = URL.createObjectURL(file);
            previewState.objectUrl = url;
            frame.style.display = 'block';
            frame.src = url;
            previewState.type = 'iframe';
            resetSearchHighlights();
        }

        function toggleSearchSection(show) {
            const section = document.getElementById('previewSearchSection');
            if (!section) return;
            section.style.display = show ? 'flex' : 'none';
            if (!show) {
                const input = section.querySelector('#previewSearchInput');
                if (input) input.value = '';
            }
        }

        function setSupportText(text) {
            const support = document.getElementById('previewSupportText');
            if (!support) return;
            if (text) {
                support.textContent = text;
                support.style.display = 'block';
            } else {
                support.textContent = '';
                support.style.display = 'none';
            }
        }

        function resetPreviewArea() {
            const bodyEl = document.getElementById('resumePreviewBody');
            const frame = document.getElementById('resumePreviewFrame');
            const searchInputEl = document.getElementById('previewSearchInput');
            if (bodyEl) {
                bodyEl.innerHTML = '';
                bodyEl.style.display = 'none';
            }
            if (frame) {
                frame.style.display = 'none';
                frame.src = 'about:blank';
            }
            if (searchInputEl) {
                searchInputEl.value = '';
            }
            setSupportText('');
            resetSearchHighlights();
        }

        function cleanupPreviewResources() {
            if (previewState.objectUrl) {
                URL.revokeObjectURL(previewState.objectUrl);
                previewState.objectUrl = null;
            }
            previewState.type = 'none';
            previewState.originalHtml = '';
            resetPreviewArea();
            hidePreviewLoading();
        }

        function showPreviewLoading() {
            const loader = document.getElementById('previewLoading');
            if (loader) {
                loader.style.display = 'flex';
            }
        }

        function hidePreviewLoading() {
            const loader = document.getElementById('previewLoading');
            if (loader) {
                loader.style.display = 'none';
            }
        }

        function showPreviewError(message) {
            const bodyEl = document.getElementById('resumePreviewBody');
            const frame = document.getElementById('resumePreviewFrame');
            if (frame) {
                frame.style.display = 'none';
                frame.src = 'about:blank';
            }
            if (bodyEl) {
                bodyEl.style.display = 'block';
                bodyEl.innerHTML = `<div style="color:#dc3545;">‚ùå ${message}</div>`;
            }
            toggleSearchSection(false);
            setSupportText('');
            previewState.type = 'error';
        }

        function getFileExtension(name) {
            if (!name) return '';
            const parts = name.split('.');
            return parts.length > 1 ? parts.pop().toLowerCase() : '';
        }

        function resetSearchHighlights() {
            previewState.matches = [];
            previewState.currentIndex = -1;
            updateSearchMeta();
        }

        function performPreviewSearch(term) {
            const bodyEl = document.getElementById('resumePreviewBody');
            if (!bodyEl || previewState.type !== 'text') return;

            bodyEl.innerHTML = previewState.originalHtml;
            previewState.matches = [];
            previewState.currentIndex = -1;

            if (!term) {
                updateSearchMeta();
                return;
            }

            const safeTerm = escapeRegExp(term);
            const regex = new RegExp(`(${safeTerm})`, 'gi');
            const highlighted = previewState.originalHtml.replace(regex, '<mark class="preview-match">$1</mark>');
            bodyEl.innerHTML = highlighted;
            previewState.matches = Array.from(bodyEl.querySelectorAll('mark.preview-match'));
            if (previewState.matches.length) {
                previewState.currentIndex = 0;
                focusPreviewMatch();
            }
            updateSearchMeta();
        }

        function movePreviewMatch(direction) {
            if (!previewState.matches.length) return;
            if (direction === 'next') {
                previewState.currentIndex = (previewState.currentIndex + 1) % previewState.matches.length;
            } else {
                previewState.currentIndex = (previewState.currentIndex - 1 + previewState.matches.length) % previewState.matches.length;
            }
            focusPreviewMatch();
            updateSearchMeta();
        }

        function focusPreviewMatch() {
            previewState.matches.forEach(match => match.classList.remove('active'));
            const current = previewState.matches[previewState.currentIndex];
            if (current) {
                current.classList.add('active');
                current.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function updateSearchMeta() {
            const meta = document.getElementById('previewSearchMeta');
            if (!meta) return;
            if (!previewState.matches.length) {
                meta.textContent = '';
                return;
            }
            meta.textContent = `${previewState.currentIndex + 1} / ${previewState.matches.length}`;
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+\-?^${}()|[\]\\]/g, '\\$&');
        }

        function displayError(message){ resultsContent.innerHTML = `<div class="result-box error"><h3>‚ùå Error</h3><div class="result-value">${message}</div></div>`; }
        
        // Create Fireworks Animation
        function createFireworks(centerX, centerY) {
            // Remove existing fireworks container
            const existingContainer = document.getElementById('fireworksContainer');
            if (existingContainer) {
                existingContainer.remove();
            }
            
            // Create fireworks container
            const container = document.createElement('div');
            container.id = 'fireworksContainer';
            document.body.appendChild(container);
            
            const colors = ['red', 'rose', 'pink', 'orange'];
            const particleCount = 80; // Number of particles per burst
            const bursts = 3; // Number of bursts
            
            for (let burst = 0; burst < bursts; burst++) {
                setTimeout(() => {
                    for (let i = 0; i < particleCount; i++) {
                        const particle = document.createElement('div');
                        particle.className = `firework-particle ${colors[Math.floor(Math.random() * colors.length)]}`;
                        
                        // Random angle for circular burst
                        const angle = (Math.PI * 2 * i) / particleCount + (Math.random() * 0.5 - 0.25);
                        const velocity = 150 + Math.random() * 100; // Random velocity
                        const tx = Math.cos(angle) * velocity;
                        const ty = Math.sin(angle) * velocity;
                        
                        particle.style.left = centerX + 'px';
                        particle.style.top = centerY + 'px';
                        particle.style.setProperty('--tx', tx + 'px');
                        particle.style.setProperty('--ty', ty + 'px');
                        particle.style.animation = `firework ${0.8 + Math.random() * 0.4}s ease-out forwards`;
                        
                        container.appendChild(particle);
                        
                        // Remove particle after animation
                        setTimeout(() => {
                            if (particle.parentNode) {
                                particle.parentNode.removeChild(particle);
                            }
                        }, 1200);
                    }
                }, burst * 200); // Stagger bursts
            }
            
            // Remove container after all animations complete
            setTimeout(() => {
                if (container.parentNode) {
                    container.parentNode.removeChild(container);
                }
            }, 3000);
        }
        
        // Email Sent Popup Notification Function
        function showEmailSentPopup() {
            // Remove any existing popup
            const existingPopup = document.getElementById('emailSentPopup');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            // Get center of screen for fireworks
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            
            // Create fireworks animation
            createFireworks(centerX, centerY);
            
            // Create new popup element
            const popup = document.createElement('div');
            popup.id = 'emailSentPopup';
            popup.innerHTML = '<div class="check-icon">‚úì</div><div class="sent-text">SENT</div>';
            document.body.appendChild(popup);
            
            // Trigger reflow to ensure initial state is applied
            void popup.offsetWidth;
            
            // Show popup with animation
            setTimeout(() => {
                popup.classList.add('show');
            }, 10);
            
            // Hide after 2 seconds
            setTimeout(() => {
                popup.classList.remove('show');
                popup.classList.add('hide');
                // Remove from DOM after animation completes
                setTimeout(() => {
                    if (popup.parentNode) {
                        popup.parentNode.removeChild(popup);
                    }
                }, 400); // Wait for hide animation to complete
            }, 2000);
        }
    </script>
</body>
</html>
